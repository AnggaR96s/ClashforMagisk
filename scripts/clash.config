#!/system/bin/sh

# date day
date_day=`date "+%a %d %b %Y (%R) %Z"`
pref_id="5000"
mark_id="2022"
table_id="2022"
mode="blacklist"
port_detect="true"
filter_local="false"
static_dns="false"
info_core="true"
nat_kernel="false"

use_premium=true
use_config="false"
config_online="false"

if [ "${use_premium}" == "true" ]; then
    tun_device="utun"
else
    tun_device="Meta"
fi

# CGROUP untuk membatasi penggunaan memori,
Cgroup_memory="true"
Cgroup_memory_path=""
Cgroup_memory_limit="10M"

# directory Clash & file
Clash_bin_name="clash"
Clash_data_dir="/data/adb/clash"
busybox_path="/data/adb/magisk/busybox"
Clash_dns="/data/adb/clash/clash.dns"
Clash_run_path="/data/adb/clash/run"
cmd_run="/data/adb/clash/run/cmdRunning"
CFM_logs_file="/data/adb/clash/run/run.log"
CFM_logs_file_update="/data/adb/clash/run/update.log"
Clash_pid_file="/data/adb/clash/run/clash.pid"
Clash_bin_path="/data/adb/clash/core/${Clash_bin_name}"

# lib core
Clash_premium="/data/adb/clash/core/lib/Clash.Premium"
Clash_meta_linux="/data/adb/clash/core/lib/Clash.Meta-tproxy"
Clash_meta_android="/data/adb/clash/core/lib/Clash.Meta-tun"

if [ "${use_config}" == "false" ]; then
    Clash_config_file="/data/adb/clash/config.yaml"
else
    Clash_config_file="/data/adb/clash/confs/config/${use_config}"
fi

temporary_config_file="/data/adb/clash/run/config.yaml"
Clash_scripts_dir="/data/adb/clash/scripts"
appuid_file="/data/adb/clash/run/appuid.list"
filter_packages_file="/data/adb/clash/packages.list"
system_packages_file="/data/system/packages.list"

# @weekly	“At 00:00 on Sunday.”
# @daily	“At 00:00.”
# @hourly	“At minute 0”
# @reboot	“After rebooting.”
# */5 * * * * "dalam 5 menit sekali"
# info set interval https://crontab.guru/
update_interval="false"

# setting auto Subcript
auto_updateSubcript="false"
Subcript_url="https://sub.cm/MZNsHkB"

# setting Update GeoX
auto_updateGeoX="false"
Clash_geodata_mode=$(grep "geodata-mode" ${Clash_dns} | ${busybox_path} awk -F ': ' '{print $2}')
if [ "${Clash_geodata_mode}" == "false" ]; then
    Clash_Country_file="/data/adb/clash/Country.mmdb"
    GeoIP_dat_url="https://cdn.jsdelivr.net/gh/Dreamacro/maxmind-geoip@release/Country.mmdb"
else
    Clash_GeoIP_file="/data/adb/clash/GeoIP.dat"
    GeoIP_dat_url="https://github.com/Loyalsoldier/v2ray-rules-dat/raw/release/geoip.dat"
fi
Clash_GeoSite_file="/data/adb/clash/GeoSite.dat"
GeoSite_url="https://github.com/Loyalsoldier/v2ray-rules-dat/raw/release/geosite.dat"

# setting permission Clash/file
Clash_permissions="6755"
Clash_user_group="root:net_admin"

# android old 4 - 8 ubah ke {"iptables_wait="iptables"}
# flash Busybox NDK
iptables_wait="iptables -w 100"
ip6tables_wait="ip6tables -w 100"

# Grep file/port
ipv6=$(grep "ipv6" ${Clash_dns} | ${busybox_path} awk -F ': ' '{print $2}' | sort -u)
Clash_user=$(echo ${Clash_user_group} | ${busybox_path} awk -F ':' '{print $1}')
Clash_group=$(echo ${Clash_user_group} | ${busybox_path} awk -F ':' '{print $2}')
Clash_tproxy_port=$(grep "tproxy-port" ${Clash_dns} | ${busybox_path} awk -F ': ' '{print $2}')
Clash_redir_port=$(grep "redir-port" ${Clash_dns} | ${busybox_path} awk -F ':' '{print $2}')
Clash_mixed_port=$(grep "mixed-port" ${Clash_dns} | ${busybox_path} awk -F ':' '{print $2}')
Clash_dns_port=$(grep "listen" ${Clash_dns} | ${busybox_path} awk -F ':' '{print $3}')
Clash_tun_status=$(${busybox_path} awk -F ': ' '/^tun: *$/{getline; print $2}' ${Clash_dns})
Clash_auto_route=$(grep "auto-route" ${Clash_dns} | ${busybox_path} awk -F ': ' '{print $2}')
Clash_auto_detect_interface=$(grep "auto-detect-interface" ${Clash_dns} | ${busybox_path} awk -F ': ' '{print $2}')
Clash_tcp_concurrent=$(grep "tcp-concurrent" ${Clash_dns} | ${busybox_path} awk -F ':' '{print $2}')
Clash_enhanced_mode=$(grep "enhanced-mode" ${Clash_dns} | ${busybox_path} awk -F ': ' '{print $2}')
# tun_device=$(${busybox_path} awk -F ': ' '/ +device: /{print $2}' ${Clash_dns})
auto_iptables=$(${busybox_path} awk -F ': ' '/^iptables: *$/{getline; print $2}' ${Clash_dns})

# internet ipv4 & ipv6
reserved_ip=(0.0.0.0/8 10.0.0.0/8 100.64.0.0/10 127.0.0.0/8 169.254.0.0/16 172.16.0.0/12 192.0.0.0/24 192.0.2.0/24 192.88.99.0/24 192.168.0.0/16 198.51.100.0/24 203.0.113.0/24 224.0.0.0/4 233.252.0.0/24 240.0.0.0/4 255.255.255.255/32)

reserved_ip6=(::/128 ::1/128 ::ffff:0:0/96 100::/64 64:ff9b::/96 2001::/32 2001:10::/28 2001:20::/28 2001:db8::/32 2002::/16 fc00::/7 fe80::/10 ff00::/8)

# Special AIDs (include/private/android_filesystem_config.h): //0 root; 2000 adb; 9997 everybody; 9999 nobody; // 1051 netd; 1052 dnsmasq; 3003 AF_INET; 3004 inet; 3005 net_admin; // 2900-2999 5000-5999 OEM; 10000+ APP; 99000-99999 ISOLATE; 100000 USER; 50000-59999 SHARED_GID
AIDs=(3005 9999)

# ps -eo pid,lstart,etime | grep $(cat /data/adb/clash/run/clash.pid)